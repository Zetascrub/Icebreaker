{% extends "base.html" %}

{% block title %}Screenshots - Scan {{ scan_id }}{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Web Screenshots</h1>
            <p class="mt-1 text-sm text-gray-500" id="scan-name">Loading...</p>
        </div>
        <div class="flex space-x-3">
            <button onclick="captureScreenshots()" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                üì∏ Capture Screenshots
            </button>
            <a href="/scans/{{ scan_id }}" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                ‚Üê Back to Scan
            </a>
        </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4" id="stats-container">
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <span class="text-2xl">üìä</span>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Total Screenshots</dt>
                            <dd class="text-2xl font-bold text-gray-900" id="stat-total">0</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <span class="text-2xl">‚úÖ</span>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Successful</dt>
                            <dd class="text-2xl font-bold text-green-600" id="stat-success">0</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <span class="text-2xl">‚ùå</span>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Failed</dt>
                            <dd class="text-2xl font-bold text-red-600" id="stat-failed">0</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <span class="text-2xl">‚è≥</span>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Pending</dt>
                            <dd class="text-2xl font-bold text-yellow-600" id="stat-pending">0</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white shadow rounded-lg p-4">
        <div class="flex flex-wrap gap-4">
            <div class="flex-1 min-w-64">
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select id="filter-status" onchange="loadScreenshots()" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <option value="">All</option>
                    <option value="success">Success</option>
                    <option value="failed">Failed</option>
                    <option value="pending">Pending</option>
                </select>
            </div>

            <div class="flex-1 min-w-64">
                <label class="block text-sm font-medium text-gray-700 mb-1">Technology</label>
                <select id="filter-technology" onchange="loadScreenshots()" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <option value="">All</option>
                </select>
            </div>

            <div class="flex-1 min-w-64">
                <label class="block text-sm font-medium text-gray-700 mb-1">View</label>
                <select id="view-mode" onchange="changeViewMode()" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <option value="grid">Grid View</option>
                    <option value="list">List View</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Screenshots Grid -->
    <div id="screenshots-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Screenshots will be loaded here -->
    </div>

    <!-- Screenshots List (hidden by default) -->
    <div id="screenshots-list" class="hidden space-y-4">
        <!-- List view will be loaded here -->
    </div>

    <!-- Loading state -->
    <div id="loading-state" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
        <p class="mt-4 text-gray-600">Loading screenshots...</p>
    </div>

    <!-- Empty state -->
    <div id="empty-state" class="hidden text-center py-12">
        <span class="text-6xl">üì∏</span>
        <h3 class="mt-2 text-lg font-medium text-gray-900">No screenshots yet</h3>
        <p class="mt-1 text-sm text-gray-500">Click "Capture Screenshots" to start capturing web service screenshots.</p>
    </div>
</div>

<!-- Lightbox Modal -->
<div id="lightbox-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4" onclick="closeLightbox()">
    <div class="relative max-w-7xl max-h-full" onclick="event.stopPropagation()">
        <button onclick="closeLightbox()" class="absolute -top-10 right-0 text-white hover:text-gray-300">
            <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        <img id="lightbox-image" src="" alt="Screenshot" class="max-w-full max-h-screen rounded-lg shadow-2xl">
        <div id="lightbox-details" class="mt-4 bg-white rounded-lg p-4 text-sm">
            <!-- Details will be loaded here -->
        </div>
    </div>
</div>

<script>
const scanId = {{ scan_id }};
let screenshots = [];
let currentViewMode = 'grid';

async function loadScanInfo() {
    const response = await fetch(`/api/scans/${scanId}`);
    const scan = await response.json();
    document.getElementById('scan-name').textContent = `Scan: ${scan.name || scan.run_id}`;
}

async function loadSummary() {
    const response = await fetch(`/api/scans/${scanId}/screenshots/summary`);
    const data = await response.json();

    document.getElementById('stat-total').textContent = data.total_screenshots;
    document.getElementById('stat-success').textContent = data.successful;
    document.getElementById('stat-failed').textContent = data.failed;
    document.getElementById('stat-pending').textContent = data.pending;

    // Populate technology filter
    const techFilter = document.getElementById('filter-technology');
    const currentValue = techFilter.value;
    techFilter.innerHTML = '<option value="">All</option>';
    data.technologies.forEach(tech => {
        const option = document.createElement('option');
        option.value = tech;
        option.textContent = tech;
        techFilter.appendChild(option);
    });
    techFilter.value = currentValue;
}

async function loadScreenshots() {
    const status = document.getElementById('filter-status').value;
    const technology = document.getElementById('filter-technology').value;

    let url = `/api/scans/${scanId}/screenshots?`;
    if (status) url += `status=${status}&`;
    if (technology) url += `technology=${technology}&`;

    const response = await fetch(url);
    const data = await response.json();
    screenshots = data.screenshots;

    document.getElementById('loading-state').classList.add('hidden');

    if (screenshots.length === 0) {
        document.getElementById('empty-state').classList.remove('hidden');
        document.getElementById('screenshots-grid').classList.add('hidden');
        document.getElementById('screenshots-list').classList.add('hidden');
        return;
    }

    document.getElementById('empty-state').classList.add('hidden');

    if (currentViewMode === 'grid') {
        renderGridView();
    } else {
        renderListView();
    }
}

function renderGridView() {
    document.getElementById('screenshots-grid').classList.remove('hidden');
    document.getElementById('screenshots-list').classList.add('hidden');

    const grid = document.getElementById('screenshots-grid');
    grid.innerHTML = screenshots.map(screenshot => {
        const statusColor = screenshot.capture_status === 'success' ? 'text-green-600' :
                           screenshot.capture_status === 'failed' ? 'text-red-600' : 'text-yellow-600';

        const imageUrl = screenshot.capture_status === 'success' ?
            `/api/screenshots/${screenshot.id}/image` :
            'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="300"%3E%3Crect fill="%23f3f4f6" width="400" height="300"/%3E%3Ctext x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="20" fill="%239ca3af"%3ENo Image%3C/text%3E%3C/svg%3E';

        return `
            <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
                <div class="aspect-w-16 aspect-h-9 bg-gray-100 cursor-pointer" onclick="openLightbox(${screenshot.id})">
                    <img src="${imageUrl}" alt="${screenshot.page_title || screenshot.url}"
                         class="object-cover w-full h-48"
                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22300%22%3E%3Crect fill=%22%23f3f4f6%22 width=%22400%22 height=%22300%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22sans-serif%22 font-size=%2220%22 fill=%22%239ca3af%22%3EError Loading%3C/text%3E%3C/svg%3E'">
                </div>
                <div class="p-4">
                    <h3 class="font-medium text-gray-900 truncate" title="${screenshot.page_title || screenshot.url}">
                        ${screenshot.page_title || screenshot.url}
                    </h3>
                    <p class="text-sm text-gray-500 truncate mt-1">${screenshot.url}</p>
                    <div class="mt-2 flex items-center justify-between">
                        <span class="text-xs ${statusColor} font-medium">
                            ${screenshot.capture_status.toUpperCase()}
                        </span>
                        ${screenshot.status_code ? `<span class="text-xs text-gray-500">HTTP ${screenshot.status_code}</span>` : ''}
                    </div>
                    ${screenshot.technologies.length > 0 ? `
                        <div class="mt-2 flex flex-wrap gap-1">
                            ${screenshot.technologies.slice(0, 3).map(tech => `
                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                    ${tech}
                                </span>
                            `).join('')}
                            ${screenshot.technologies.length > 3 ? `<span class="text-xs text-gray-500">+${screenshot.technologies.length - 3}</span>` : ''}
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
}

function renderListView() {
    document.getElementById('screenshots-grid').classList.add('hidden');
    document.getElementById('screenshots-list').classList.remove('hidden');

    const list = document.getElementById('screenshots-list');
    list.innerHTML = screenshots.map(screenshot => {
        const statusColor = screenshot.capture_status === 'success' ? 'text-green-600' :
                           screenshot.capture_status === 'failed' ? 'text-red-600' : 'text-yellow-600';

        const imageUrl = screenshot.capture_status === 'success' ?
            `/api/screenshots/${screenshot.id}/image` : '';

        return `
            <div class="bg-white rounded-lg shadow p-4 flex space-x-4">
                ${imageUrl ? `
                    <div class="flex-shrink-0 cursor-pointer" onclick="openLightbox(${screenshot.id})">
                        <img src="${imageUrl}" alt="${screenshot.page_title || screenshot.url}"
                             class="w-32 h-24 object-cover rounded"
                             onerror="this.parentElement.innerHTML='<div class=\\'w-32 h-24 bg-gray-200 rounded flex items-center justify-center text-gray-400\\'>Error</div>'">
                    </div>
                ` : '<div class="w-32 h-24 bg-gray-200 rounded flex items-center justify-center text-gray-400">No Image</div>'}
                <div class="flex-1 min-w-0">
                    <h3 class="font-medium text-gray-900">${screenshot.page_title || 'Untitled'}</h3>
                    <p class="text-sm text-gray-500 mt-1">${screenshot.url}</p>
                    <div class="mt-2 flex items-center space-x-4">
                        <span class="text-xs ${statusColor} font-medium">${screenshot.capture_status.toUpperCase()}</span>
                        ${screenshot.status_code ? `<span class="text-xs text-gray-500">HTTP ${screenshot.status_code}</span>` : ''}
                        ${screenshot.target ? `<span class="text-xs text-gray-500">${screenshot.target}:${screenshot.port}</span>` : ''}
                    </div>
                    ${screenshot.technologies.length > 0 ? `
                        <div class="mt-2 flex flex-wrap gap-1">
                            ${screenshot.technologies.map(tech => `
                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                    ${tech}
                                </span>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
}

function changeViewMode() {
    currentViewMode = document.getElementById('view-mode').value;
    if (screenshots.length > 0) {
        if (currentViewMode === 'grid') {
            renderGridView();
        } else {
            renderListView();
        }
    }
}

async function captureScreenshots() {
    if (!confirm('This will capture screenshots of all HTTP/HTTPS services. Continue?')) {
        return;
    }

    try {
        const response = await fetch(`/api/scans/${scanId}/screenshots/capture`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        });

        if (response.ok) {
            showToast('Screenshot capture started. This may take a few minutes...', 'info');
            // Reload after a delay
            setTimeout(() => {
                loadSummary();
                loadScreenshots();
            }, 5000);
        } else {
            showToast('Failed to start screenshot capture', 'error');
        }
    } catch (error) {
        showToast('Error starting screenshot capture', 'error');
    }
}

function openLightbox(screenshotId) {
    const screenshot = screenshots.find(s => s.id === screenshotId);
    if (!screenshot || screenshot.capture_status !== 'success') return;

    const modal = document.getElementById('lightbox-modal');
    const image = document.getElementById('lightbox-image');
    const details = document.getElementById('lightbox-details');

    image.src = `/api/screenshots/${screenshotId}/image`;

    details.innerHTML = `
        <div class="grid grid-cols-2 gap-4">
            <div>
                <h4 class="font-medium text-gray-900">${screenshot.page_title || 'Untitled'}</h4>
                <p class="text-sm text-gray-500 mt-1">${screenshot.url}</p>
            </div>
            <div class="text-right">
                <p class="text-sm text-gray-500">Status: <span class="font-medium">${screenshot.status_code || 'N/A'}</span></p>
                <p class="text-sm text-gray-500">Target: <span class="font-medium">${screenshot.target}:${screenshot.port}</span></p>
            </div>
        </div>
        ${screenshot.technologies.length > 0 ? `
            <div class="mt-3">
                <p class="text-sm font-medium text-gray-700 mb-2">Technologies:</p>
                <div class="flex flex-wrap gap-2">
                    ${screenshot.technologies.map(tech => `
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${tech}
                        </span>
                    `).join('')}
                </div>
            </div>
        ` : ''}
    `;

    modal.classList.remove('hidden');
}

function closeLightbox() {
    document.getElementById('lightbox-modal').classList.add('hidden');
}

// Load on page load
document.addEventListener('DOMContentLoaded', () => {
    loadScanInfo();
    loadSummary();
    loadScreenshots();

    // Auto-refresh every 10 seconds if there are pending screenshots
    setInterval(() => {
        const pendingCount = parseInt(document.getElementById('stat-pending').textContent);
        if (pendingCount > 0) {
            loadSummary();
            loadScreenshots();
        }
    }, 10000);
});

// Keyboard navigation
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeLightbox();
    }
});
</script>
{% endblock %}
