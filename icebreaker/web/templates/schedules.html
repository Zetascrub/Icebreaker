{% extends "base.html" %}

{% block title %}Scheduled Scans - Icebreaker{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex justify-between items-start">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Scheduled Scans</h1>
            <p class="mt-2 text-sm text-gray-600">Automate recurring security scans</p>
        </div>
        <button onclick="openCreateModal()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            <svg class="-ml-1 mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            New Schedule
        </button>
    </div>

    <!-- Schedules List -->
    <div id="schedules-list" class="bg-white shadow overflow-hidden sm:rounded-md">
        <div class="text-center py-12">
            <svg class="animate-spin h-12 w-12 text-gray-400 mx-auto" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-gray-500">Loading schedules...</p>
        </div>
    </div>
</div>

<!-- Create/Edit Schedule Modal -->
<div id="schedule-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-medium text-gray-900" id="modal-title">Create Schedule</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <form id="schedule-form" class="space-y-4">
            <input type="hidden" id="schedule-id">

            <div>
                <label class="block text-sm font-medium text-gray-700">Schedule Name</label>
                <input type="text" id="schedule-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Description</label>
                <textarea id="schedule-description" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Schedule Type</label>
                    <select id="schedule-type" onchange="updateScheduleHelp()" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="cron">Cron Expression</option>
                        <option value="interval">Interval</option>
                        <option value="once">One-time</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Schedule Value</label>
                    <input type="text" id="schedule-value" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>

            <div id="schedule-help" class="text-xs text-gray-500 bg-gray-50 p-3 rounded">
                <strong>Cron format:</strong> minute hour day month day_of_week<br>
                Examples: "0 9 * * *" (daily at 9am), "0 2 * * 0" (Sundays at 2am)
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Targets (one per line)</label>
                <textarea id="schedule-targets" rows="3" required placeholder="192.168.1.0/24&#10;10.0.0.1&#10;example.com" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Preset</label>
                <select id="schedule-preset" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="quick">Quick Scan</option>
                    <option value="thorough">Thorough Scan</option>
                    <option value="stealth">Stealth Scan</option>
                </select>
            </div>

            <div class="flex items-center">
                <input type="checkbox" id="schedule-enabled" checked class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                <label for="schedule-enabled" class="ml-2 block text-sm text-gray-900">
                    Enabled (start scheduling immediately)
                </label>
            </div>

            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" onclick="closeModal()" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                    Save Schedule
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    let schedules = [];

    async function loadSchedules() {
        try {
            const response = await fetch('/api/schedules');
            schedules = await response.json();

            const container = document.getElementById('schedules-list');

            if (schedules.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No schedules</h3>
                        <p class="mt-1 text-sm text-gray-500">Get started by creating a new scheduled scan.</p>
                        <div class="mt-6">
                            <button onclick="openCreateModal()" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                                <svg class="-ml-1 mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                New Schedule
                            </button>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <ul class="divide-y divide-gray-200">
                        ${schedules.map(s => renderSchedule(s)).join('')}
                    </ul>
                `;
            }
        } catch (error) {
            console.error('Error loading schedules:', error);
            showToast('Error loading schedules', 'error');
        }
    }

    function renderSchedule(schedule) {
        const nextRun = schedule.next_run ? new Date(schedule.next_run).toLocaleString() : 'Not scheduled';
        const lastRun = schedule.last_run ? new Date(schedule.last_run).toLocaleString() : 'Never';

        return `
            <li class="px-4 py-4 hover:bg-gray-50">
                <div class="flex items-center justify-between">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-3">
                            <h3 class="text-sm font-medium text-gray-900 truncate">${schedule.name}</h3>
                            ${schedule.enabled ?
                                '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Enabled</span>' :
                                '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Disabled</span>'
                            }
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">${schedule.schedule_type}</span>
                        </div>
                        ${schedule.description ? `<p class="mt-1 text-sm text-gray-500">${schedule.description}</p>` : ''}
                        <div class="mt-2 flex items-center text-xs text-gray-500 space-x-4">
                            <div>
                                <span class="font-medium">Next run:</span> ${nextRun}
                            </div>
                            <div>
                                <span class="font-medium">Last run:</span> ${lastRun}
                            </div>
                            <div>
                                <span class="font-medium">Targets:</span> ${schedule.targets.length}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 ml-4">
                        ${schedule.enabled ?
                            `<button onclick="triggerSchedule(${schedule.id})" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50" title="Run now">
                                <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Run Now
                            </button>
                            <button onclick="toggleSchedule(${schedule.id}, false)" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50">
                                Disable
                            </button>` :
                            `<button onclick="toggleSchedule(${schedule.id}, true)" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-green-700 bg-white hover:bg-gray-50">
                                Enable
                            </button>`
                        }
                        <button onclick="editSchedule(${schedule.id})" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50">
                            Edit
                        </button>
                        <button onclick="deleteSchedule(${schedule.id})" class="inline-flex items-center px-3 py-1.5 border border-red-300 text-xs font-medium rounded text-red-700 bg-white hover:bg-red-50">
                            Delete
                        </button>
                    </div>
                </div>
            </li>
        `;
    }

    function updateScheduleHelp() {
        const type = document.getElementById('schedule-type').value;
        const helpDiv = document.getElementById('schedule-help');

        if (type === 'cron') {
            helpDiv.innerHTML = '<strong>Cron format:</strong> minute hour day month day_of_week<br>Examples: "0 9 * * *" (daily at 9am), "0 2 * * 0" (Sundays at 2am), "*/15 * * * *" (every 15 minutes)';
        } else if (type === 'interval') {
            helpDiv.innerHTML = '<strong>Interval format:</strong> value unit<br>Examples: "1 hours" (hourly), "30 minutes" (every 30 min), "7 days" (weekly)';
        } else {
            helpDiv.innerHTML = '<strong>One-time format:</strong> ISO datetime<br>Example: "2025-12-31T23:59:00" (specific date and time)';
        }
    }

    function openCreateModal() {
        document.getElementById('modal-title').textContent = 'Create Schedule';
        document.getElementById('schedule-form').reset();
        document.getElementById('schedule-id').value = '';
        document.getElementById('schedule-enabled').checked = true;
        document.getElementById('schedule-modal').classList.remove('hidden');
    }

    function editSchedule(id) {
        const schedule = schedules.find(s => s.id === id);
        if (!schedule) return;

        document.getElementById('modal-title').textContent = 'Edit Schedule';
        document.getElementById('schedule-id').value = schedule.id;
        document.getElementById('schedule-name').value = schedule.name;
        document.getElementById('schedule-description').value = schedule.description || '';
        document.getElementById('schedule-type').value = schedule.schedule_type;
        document.getElementById('schedule-value').value = schedule.schedule_value;
        document.getElementById('schedule-targets').value = schedule.targets.join('\n');
        document.getElementById('schedule-preset').value = schedule.scan_config?.preset || 'quick';
        document.getElementById('schedule-enabled').checked = schedule.enabled;
        document.getElementById('schedule-modal').classList.remove('hidden');
        updateScheduleHelp();
    }

    function closeModal() {
        document.getElementById('schedule-modal').classList.add('hidden');
    }

    document.getElementById('schedule-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const id = document.getElementById('schedule-id').value;
        const data = {
            name: document.getElementById('schedule-name').value,
            description: document.getElementById('schedule-description').value || null,
            schedule_type: document.getElementById('schedule-type').value,
            schedule_value: document.getElementById('schedule-value').value,
            targets: document.getElementById('schedule-targets').value.split('\n').map(t => t.trim()).filter(t => t),
            scan_config: {
                preset: document.getElementById('schedule-preset').value
            },
            enabled: document.getElementById('schedule-enabled').checked
        };

        try {
            const url = id ? `/api/schedules/${id}` : '/api/schedules';
            const method = id ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showToast(`Schedule ${id ? 'updated' : 'created'} successfully`, 'success');
                closeModal();
                loadSchedules();
            } else {
                const error = await response.json();
                showToast(error.detail || 'Error saving schedule', 'error');
            }
        } catch (error) {
            console.error('Error saving schedule:', error);
            showToast('Error saving schedule', 'error');
        }
    });

    async function toggleSchedule(id, enable) {
        try {
            const endpoint = enable ? 'enable' : 'disable';
            const response = await fetch(`/api/schedules/${id}/${endpoint}`, {method: 'POST'});

            if (response.ok) {
                showToast(`Schedule ${enable ? 'enabled' : 'disabled'}`, 'success');
                loadSchedules();
            } else {
                showToast('Error toggling schedule', 'error');
            }
        } catch (error) {
            console.error('Error toggling schedule:', error);
            showToast('Error toggling schedule', 'error');
        }
    }

    async function triggerSchedule(id) {
        if (!confirm('Run this scan now (outside of its normal schedule)?')) return;

        try {
            const response = await fetch(`/api/schedules/${id}/trigger`, {method: 'POST'});

            if (response.ok) {
                showToast('Scan triggered successfully', 'success');
            } else {
                showToast('Error triggering scan', 'error');
            }
        } catch (error) {
            console.error('Error triggering scan:', error);
            showToast('Error triggering scan', 'error');
        }
    }

    async function deleteSchedule(id) {
        if (!confirm('Are you sure you want to delete this schedule?')) return;

        try {
            const response = await fetch(`/api/schedules/${id}`, {method: 'DELETE'});

            if (response.ok) {
                showToast('Schedule deleted', 'success');
                loadSchedules();
            } else {
                showToast('Error deleting schedule', 'error');
            }
        } catch (error) {
            console.error('Error deleting schedule:', error);
            showToast('Error deleting schedule', 'error');
        }
    }

    // Load schedules on page load
    document.addEventListener('DOMContentLoaded', loadSchedules);

    // Auto-refresh every 30 seconds
    setInterval(loadSchedules, 30000);
</script>
{% endblock %}
